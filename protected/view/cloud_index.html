<style>
    .breakall {
        word-break: break-all;
    }
    .sub {
        font-size: 80%;
        font-weight: 400;
        color: gray;
    }
    tr.collapse.show {
        display: flex!important;
    }
    td {
        height: fit-content;
    }
    .clickable {
        cursor: pointer;
    }
    a.noc {
        color: #212529;
    }
    .overflow-hidden {
        overflow: hidden;
    }
    .cloud-custom-file {
        opacity: 0;
        position: relative;
        top: -.46875rem;
        left: -1rem;
        width: calc(100% + 2rem);
        height: 100%;
        cursor: pointer;
    }
</style>
<div class="container">
    <nav aria-label="breadcrumb" class="mt-3" id="mainNav">
        <ol class="breadcrumb align-items-center p-2">
            <li><button type="button" class="btn btn-lg btn-dark px-2 py-1 mb-0" data-toggle="button" id="trashBtn"><i class="MDI delete-empty"></i></button></li>
            <li><button type="button" class="btn btn-lg btn-dark px-2 py-1 mb-0" data-toggle="button" id="shareBtn" disabled><i class="MDI share-variant"></i></button></li>
            <li><button type="button" class="btn btn-lg px-2 py-1 mb-0" id="refresh"><i class="MDI refresh"></i></button></li>
            <li class="breadcrumb-item active" aria-current="page">根目录</li>
        </ol>
    </nav>
    <button class="btn nf overflow-hidden" id="uploadBtn"><div class="position-absolute h-100"><input type="file" class="cloud-custom-file" id="files" multiple/></div><i class="MDI upload lead align-middle"></i><span class="d-none d-sm-inline"> 上传文件 <span class="badge badge-pill badge-secondary" id="uploadings"></span></span></button>
    <button class="btn nf" id="newFolder"><i class="MDI folder-plus lead align-middle"></i><span class="d-none d-sm-inline"> 新建文件夹</span></button>
    <div class="float-right">
        <button type="button" class="btn btn-lg float-right" id="order">
            <i class="MDI sort-ascending" id="orderIcon"></i>
        </button>
        <button type="button" class="btn btn-lg dropdown-toggle float-right" id="sortby" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            <span class="MDI sort" aria-hidden="true" aria-label="排序"></span>
        </button>
        <div class="dropdown-menu" aria-labelledby="sortby">
            <a class="dropdown-item" href="javascript:sortBy('name');">名称</a>
            <a class="dropdown-item" href="javascript:sortBy('size');">大小</a>
            <a class="dropdown-item" href="javascript:sortBy('time');">上传时间</a>
        </div>
    </div>
    <table class="table col-12 table-hover table">
        <thead>
            <tr class="row mx-0">
                <th class="col-lg-9 col-md-7 col-sm-6 clickable cname">文件名 <i class="MDI arrow-up-bold align-middle si" id="siname"></i></th>
                <th class="col-lg-1 col-sm-2 col-4 d-none d-sm-block small clickable csize">大小 <i class="MDI arrow-up-bold align-middle si d-none" id="sisize"></i></th>
                <th class="col-lg-2 col-md-3 col-sm-4 col-4 d-none d-sm-block small clickable ctime">上传时间 <i class="MDI arrow-up-bold align-middle si d-none" id="sitime"></i></th>
            </tr>
        </thead>
    </table>
</div>
<div id="alert" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="alert_title">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="alert_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="alert_desc"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="confirm" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="confirm_title">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirm_desc" class="breakall"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirm_confirm">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="prompt" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="prompt_title">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="prompt_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input class="form-control" id="prompt_input"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="prompt_confirm">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="browse" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="prompt_title">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="browse_title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <nav aria-label="breadcrumb" class="mt-3" id="browseNav">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item active" aria-current="page">根目录</li>
                    </ol>
                </nav>
                <div class="list-group" id="dirlist"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="browse_confirm">确定</button>
            </div>
        </div>
    </div>
</div>
<div id="upload" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="upload_title">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="upload_title">上传文件</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row mx-0 align-items-center">
                    <button class="btn nf overflow-hidden" id="selectFile">
                        <div class="position-absolute h-100"></div>
                        <i class="MDI file-outline lead align-middle"></i><span class="d-none d-sm-inline"> 继续上传文件</span>
                    </button>
                    <div class="col">
                        已用空间：<span id="spaceDesc"></span>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="0" id="spacePB"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function word2hex(word) {
        let tmp = new Uint8Array(8);
        for (let i = 0; i < 8; ++i) tmp[i] = byte2hex((word >> (28 - (i << 2))) & 15);
        return new TextDecoder().decode(tmp);
    }

    // must use new SHA1(blob, callback)
    const SHIFT = [24, 16, 8, 0];
    function SHA1(blob, callback) {
        this.blocks = new Array(16);
        this.a = 0x67452301;
        this.b = 0xEFCDAB89;
        this.c = 0x98BADCFE;
        this.d = 0x10325476;
        this.e = 0xC3D2E1F0;
        blob.arrayBuffer().then(buffer => {
            var data = new Uint8Array(buffer);
            var index = 0, i, blocks = this.blocks, length = data.length;
            while (index < length) {
                this.clear();
                for (i = 0; index < length && i < 64; ++index, ++i) {
                    blocks[i >> 2] |= data[index] << SHIFT[i & 3];
                }
                if (i == 64) {
                    this.hash();
                    this.clear();
                    i = 0;
                }
            }
            blocks[i >> 2] |= 1 << (31 - ((i & 3) << 3));
            if (i >= 56) {
                this.hash();
                this.clear();
            }
            blocks[14] = length / 536870912 << 0;
            blocks[15] = length % 536870912 << 3;
            this.hash();
            callback(word2hex(this.a)
                + word2hex(this.b)
                + word2hex(this.c)
                + word2hex(this.d)
                + word2hex(this.e));
        });
    }

    SHA1.prototype.clear = function () {
        var blocks = this.blocks;
        blocks[0] = blocks[1] = blocks[2] = blocks[3] =
            blocks[4] = blocks[5] = blocks[6] = blocks[7] =
            blocks[8] = blocks[9] = blocks[10] = blocks[11] =
            blocks[12] = blocks[13] = blocks[14] = blocks[15] = 0;
    };

    SHA1.prototype.hash = function () {
        var a = this.a, b = this.b, c = this.c, d = this.d, e = this.e;
        var f, j, t, blocks = this.blocks;

        for (j = 16; j < 80; ++j) {
            t = blocks[j - 3] ^ blocks[j - 8] ^ blocks[j - 14] ^ blocks[j - 16];
            blocks[j] = (t << 1) | (t >>> 31);
        }

        for (j = 0; j < 20; j += 5) {
            f = (b & c) | ((~b) & d);
            t = (a << 5) | (a >>> 27);
            e = t + f + e + 0x5A827999 + blocks[j] << 0;
            b = (b << 30) | (b >>> 2);

            f = (a & b) | ((~a) & c);
            t = (e << 5) | (e >>> 27);
            d = t + f + d + 0x5A827999 + blocks[j + 1] << 0;
            a = (a << 30) | (a >>> 2);

            f = (e & a) | ((~e) & b);
            t = (d << 5) | (d >>> 27);
            c = t + f + c + 0x5A827999 + blocks[j + 2] << 0;
            e = (e << 30) | (e >>> 2);

            f = (d & e) | ((~d) & a);
            t = (c << 5) | (c >>> 27);
            b = t + f + b + 0x5A827999 + blocks[j + 3] << 0;
            d = (d << 30) | (d >>> 2);

            f = (c & d) | ((~c) & e);
            t = (b << 5) | (b >>> 27);
            a = t + f + a + 0x5A827999 + blocks[j + 4] << 0;
            c = (c << 30) | (c >>> 2);
        }

        for (; j < 40; j += 5) {
            f = b ^ c ^ d;
            t = (a << 5) | (a >>> 27);
            e = t + f + e + 0x6ED9EBA1 + blocks[j] << 0;
            b = (b << 30) | (b >>> 2);

            f = a ^ b ^ c;
            t = (e << 5) | (e >>> 27);
            d = t + f + d + 0x6ED9EBA1 + blocks[j + 1] << 0;
            a = (a << 30) | (a >>> 2);

            f = e ^ a ^ b;
            t = (d << 5) | (d >>> 27);
            c = t + f + c + 0x6ED9EBA1 + blocks[j + 2] << 0;
            e = (e << 30) | (e >>> 2);

            f = d ^ e ^ a;
            t = (c << 5) | (c >>> 27);
            b = t + f + b + 0x6ED9EBA1 + blocks[j + 3] << 0;
            d = (d << 30) | (d >>> 2);

            f = c ^ d ^ e;
            t = (b << 5) | (b >>> 27);
            a = t + f + a + 0x6ED9EBA1 + blocks[j + 4] << 0;
            c = (c << 30) | (c >>> 2);
        }

        for (; j < 60; j += 5) {
            f = (b & c) | (b & d) | (c & d);
            t = (a << 5) | (a >>> 27);
            e = t + f + e + 0x8F1BBCDC + blocks[j] << 0;
            b = (b << 30) | (b >>> 2);

            f = (a & b) | (a & c) | (b & c);
            t = (e << 5) | (e >>> 27);
            d = t + f + d + 0x8F1BBCDC + blocks[j + 1] << 0;
            a = (a << 30) | (a >>> 2);

            f = (e & a) | (e & b) | (a & b);
            t = (d << 5) | (d >>> 27);
            c = t + f + c + 0x8F1BBCDC + blocks[j + 2] << 0;
            e = (e << 30) | (e >>> 2);

            f = (d & e) | (d & a) | (e & a);
            t = (c << 5) | (c >>> 27);
            b = t + f + b + 0x8F1BBCDC + blocks[j + 3] << 0;
            d = (d << 30) | (d >>> 2);

            f = (c & d) | (c & e) | (d & e);
            t = (b << 5) | (b >>> 27);
            a = t + f + a + 0x8F1BBCDC + blocks[j + 4] << 0;
            c = (c << 30) | (c >>> 2);
        }

        for (; j < 80; j += 5) {
            f = b ^ c ^ d;
            t = (a << 5) | (a >>> 27);
            e = t + f + e + 0xCA62C1D6 + blocks[j] << 0;
            b = (b << 30) | (b >>> 2);

            f = a ^ b ^ c;
            t = (e << 5) | (e >>> 27);
            d = t + f + d + 0xCA62C1D6 + blocks[j + 1] << 0;
            a = (a << 30) | (a >>> 2);

            f = e ^ a ^ b;
            t = (d << 5) | (d >>> 27);
            c = t + f + c + 0xCA62C1D6 + blocks[j + 2] << 0;
            e = (e << 30) | (e >>> 2);

            f = d ^ e ^ a;
            t = (c << 5) | (c >>> 27);
            b = t + f + b + 0xCA62C1D6 + blocks[j + 3] << 0;
            d = (d << 30) | (d >>> 2);

            f = c ^ d ^ e;
            t = (b << 5) | (b >>> 27);
            a = t + f + a + 0xCA62C1D6 + blocks[j + 4] << 0;
            c = (c << 30) | (c >>> 2);
        }

        this.a = this.a + a << 0;
        this.b = this.b + b << 0;
        this.c = this.c + c << 0;
        this.d = this.d + d << 0;
        this.e = this.e + e << 0;
    };

function byte2hex(v) { return (v < 10 ? 48 : 87) + v; }

function raw2hex(arraybuffer) {
	let data = new Uint8Array(arraybuffer);
	let tmp = new Uint8Array(data.byteLength * 2);
	for (let i = 0; i < data.byteLength; ++i) {
		tmp[i << 1] = byte2hex(data[i] >> 4);
		tmp[i << 1 | 1] = byte2hex(data[i] & 15);
	}
	return new TextDecoder().decode(tmp);
}

function hex2byte(v) { return  (v | 32) - (v < 58 ? 48 : 87); }

function hex2raw(str) {
	let data = new TextEncoder().encode(str);
	let tmp = new Uint8Array(data.byteLength >> 1);
	for (let i = 0; i < tmp.byteLength; ++i) {
		tmp[i] = hex2byte(data[i << 1]) << 4 | hex2byte(data[i << 1 | 1]);
	}
	return tmp;
}

//加密
function FileEncrypter(blob, callback) {
	blob.arrayBuffer().then(data => {
		data = raw2hex(data);
		var result = [];
		for (var i = 0; i < data.length; i += 32) {
			var tmp = data.substr(i, 32);
			if (tmp.length < 32) {
				var pad = '0' + String.fromCharCode(byte2hex(16 - tmp.length / 2));
				while (tmp.length < 32) tmp += pad;
			}
			result.push(hex2raw(encrypt(tmp, encryptKey)));
		}
		callback(new Blob(result));
	})
}
//解密
function FileDecrypter(blob, callback) {
	blob.arrayBuffer().then(data => {
		data = raw2hex(data);
		var result = [];
		for (var i = 0; i < data.length; i += 32) {
			result.push(hex2raw(decrypt(data.substr(i, 32), encryptKey)));
		}
		var last = raw2hex(result[result.length - 1]);
		var pad = last.substr(30), padv = parseInt(pad, 16);
		var haspad = true;
		if (padv < 16) {
			for (i = 1; i < padv && haspad; ++i) {
				if (last.substr(30 - i * 2, 2) != pad) haspad = false;
			}
		} else haspad = false;
		if (haspad) last = last.substr(0, 32 - padv * 2);
		result[result.length - 1] = hex2raw(last);
		callback(new Blob(result));
	})
}




// 左移
let left_move = (text, number) => {
  return text.substr(number) + text.substr(0, number);
}

// 将字符串转化为ASCII
 let to_8binary = (text) => {
  if (text == null) {
    return null;
  }
  let binary = "";
  for (let i = 0; i < text.length; i++) {
    let charCode = text.charCodeAt(i);
    if (charCode > 255) {
      throw new SyntaxError;
    }
    binary += charCode.toString(2).padStart(8, '0');
  }
  return binary;
}

// 将字符串转化为4位二进制格式,比如to_4binary(13)=00010011
 let to_4binary = (text) => {
  if (text == null) {
    return null;
  }
  let binary = "";
  for (let i = 0; i < text.length; i++) {
    let charCode = parseInt(text.charAt(i), 16).toString(2);
    binary += charCode.padStart(4, '0');
  }
  return binary;
}

/**
 * 将二进制字符串转成16进制
 * @param bin
 * @returns {string}
 */
let bin_to_hex = (bin) => {
  return parseInt(bin, 2).toString(16);
}

// 将10进制换成4位二进制
 let decimal_to_binary = (hex) => {
  let charCode = parseInt(hex, 10).toString(2);
  return charCode.padStart(4, '0');
}

 let binary_to_hex = (binary) => {
  let result = "";
  for (let i = 0; i < binary.length; i += 4) {
    result += parseInt(binary.substr(i, 4), 2).toString(16);
  }
  return result;
}

/**
 * 二进制异或
 * @param x 二进制输入X
 * @param y 二进制输入Y
 * @returns {string}
 */
let xor_bin = (x, y) => {
  let result = "";
  for (let i = 0; i < x.length; i++) {
    if (String(x).charAt(i) === String(y).charAt(i)) {
      result += "0";
    } else {
      result += "1";
    }
  }
  return result;
}

/**
 * 两位16进制进行异或
 * @param hexA 两位16进制字符串A
 * @param hexB 两位16进制字符串B
 * @returns {string}
 */
 let xor_hex = (hexA, hexB) => {
  let result = "";
  // 先将16进制字符串转换成二进制
  let binaryA = to_4binary(hexA);
  let binaryB = to_4binary(hexB);
  // 对二进制进行异或
  result = xor_bin(binaryA, binaryB);
  // 将异或结果转成16进制
  return bin_to_hex(result).padStart(2, '0');
}

/**
 * 多位16进制进行异或计算
 * @param hexA
 * @param hexB
 * @returns {string}
 */
 let xor_hex_fill = (hexA, hexB) => {
  let len = hexA.length > hexB.length ? hexA.length : hexB.length;
  let result = '';
  for (let i = 0; i < len; i += 2) {
    result += xor_hex(hexA.substr(i, 2), hexB.substr(i, 2));
  }
  return result;
}
/*
* S盒
*/
let S_BOX = [
  0x63, 0x7c, 0x77, 0x7b, 0xf2, 0x6b, 0x6f, 0xc5, 0x30, 0x01, 0x67, 0x2b, 0xfe, 0xd7, 0xab, 0x76,
  0xca, 0x82, 0xc9, 0x7d, 0xfa, 0x59, 0x47, 0xf0, 0xad, 0xd4, 0xa2, 0xaf, 0x9c, 0xa4, 0x72, 0xc0,
  0xb7, 0xfd, 0x93, 0x26, 0x36, 0x3f, 0xf7, 0xcc, 0x34, 0xa5, 0xe5, 0xf1, 0x71, 0xd8, 0x31, 0x15,
  0x04, 0xc7, 0x23, 0xc3, 0x18, 0x96, 0x05, 0x9a, 0x07, 0x12, 0x80, 0xe2, 0xeb, 0x27, 0xb2, 0x75,
  0x09, 0x83, 0x2c, 0x1a, 0x1b, 0x6e, 0x5a, 0xa0, 0x52, 0x3b, 0xd6, 0xb3, 0x29, 0xe3, 0x2f, 0x84,
  0x53, 0xd1, 0x00, 0xed, 0x20, 0xfc, 0xb1, 0x5b, 0x6a, 0xcb, 0xbe, 0x39, 0x4a, 0x4c, 0x58, 0xcf,
  0xd0, 0xef, 0xaa, 0xfb, 0x43, 0x4d, 0x33, 0x85, 0x45, 0xf9, 0x02, 0x7f, 0x50, 0x3c, 0x9f, 0xa8,
  0x51, 0xa3, 0x40, 0x8f, 0x92, 0x9d, 0x38, 0xf5, 0xbc, 0xb6, 0xda, 0x21, 0x10, 0xff, 0xf3, 0xd2,
  0xcd, 0x0c, 0x13, 0xec, 0x5f, 0x97, 0x44, 0x17, 0xc4, 0xa7, 0x7e, 0x3d, 0x64, 0x5d, 0x19, 0x73,
  0x60, 0x81, 0x4f, 0xdc, 0x22, 0x2a, 0x90, 0x88, 0x46, 0xee, 0xb8, 0x14, 0xde, 0x5e, 0x0b, 0xdb,
  0xe0, 0x32, 0x3a, 0x0a, 0x49, 0x06, 0x24, 0x5c, 0xc2, 0xd3, 0xac, 0x62, 0x91, 0x95, 0xe4, 0x79,
  0xe7, 0xc8, 0x37, 0x6d, 0x8d, 0xd5, 0x4e, 0xa9, 0x6c, 0x56, 0xf4, 0xea, 0x65, 0x7a, 0xae, 0x08,
  0xba, 0x78, 0x25, 0x2e, 0x1c, 0xa6, 0xb4, 0xc6, 0xe8, 0xdd, 0x74, 0x1f, 0x4b, 0xbd, 0x8b, 0x8a,
  0x70, 0x3e, 0xb5, 0x66, 0x48, 0x03, 0xf6, 0x0e, 0x61, 0x35, 0x57, 0xb9, 0x86, 0xc1, 0x1d, 0x9e,
  0xe1, 0xf8, 0x98, 0x11, 0x69, 0xd9, 0x8e, 0x94, 0x9b, 0x1e, 0x87, 0xe9, 0xce, 0x55, 0x28, 0xdf,
  0x8c, 0xa1, 0x89, 0x0d, 0xbf, 0xe6, 0x42, 0x68, 0x41, 0x99, 0x2d, 0x0f, 0xb0, 0x54, 0xbb, 0x16,
];

/*
* 逆S盒
*/
let INVERSE_S_BOX = [
  0x52, 0x09, 0x6a, 0xd5, 0x30, 0x36, 0xa5, 0x38, 0xbf, 0x40, 0xa3, 0x9e, 0x81, 0xf3, 0xd7, 0xfb,
  0x7c, 0xe3, 0x39, 0x82, 0x9b, 0x2f, 0xff, 0x87, 0x34, 0x8e, 0x43, 0x44, 0xc4, 0xde, 0xe9, 0xcb,
  0x54, 0x7b, 0x94, 0x32, 0xa6, 0xc2, 0x23, 0x3d, 0xee, 0x4c, 0x95, 0x0b, 0x42, 0xfa, 0xc3, 0x4e,
  0x08, 0x2e, 0xa1, 0x66, 0x28, 0xd9, 0x24, 0xb2, 0x76, 0x5b, 0xa2, 0x49, 0x6d, 0x8b, 0xd1, 0x25,
  0x72, 0xf8, 0xf6, 0x64, 0x86, 0x68, 0x98, 0x16, 0xd4, 0xa4, 0x5c, 0xcc, 0x5d, 0x65, 0xb6, 0x92,
  0x6c, 0x70, 0x48, 0x50, 0xfd, 0xed, 0xb9, 0xda, 0x5e, 0x15, 0x46, 0x57, 0xa7, 0x8d, 0x9d, 0x84,
  0x90, 0xd8, 0xab, 0x00, 0x8c, 0xbc, 0xd3, 0x0a, 0xf7, 0xe4, 0x58, 0x05, 0xb8, 0xb3, 0x45, 0x06,
  0xd0, 0x2c, 0x1e, 0x8f, 0xca, 0x3f, 0x0f, 0x02, 0xc1, 0xaf, 0xbd, 0x03, 0x01, 0x13, 0x8a, 0x6b,
  0x3a, 0x91, 0x11, 0x41, 0x4f, 0x67, 0xdc, 0xea, 0x97, 0xf2, 0xcf, 0xce, 0xf0, 0xb4, 0xe6, 0x73,
  0x96, 0xac, 0x74, 0x22, 0xe7, 0xad, 0x35, 0x85, 0xe2, 0xf9, 0x37, 0xe8, 0x1c, 0x75, 0xdf, 0x6e,
  0x47, 0xf1, 0x1a, 0x71, 0x1d, 0x29, 0xc5, 0x89, 0x6f, 0xb7, 0x62, 0x0e, 0xaa, 0x18, 0xbe, 0x1b,
  0xfc, 0x56, 0x3e, 0x4b, 0xc6, 0xd2, 0x79, 0x20, 0x9a, 0xdb, 0xc0, 0xfe, 0x78, 0xcd, 0x5a, 0xf4,
  0x1f, 0xdd, 0xa8, 0x33, 0x88, 0x07, 0xc7, 0x31, 0xb1, 0x12, 0x10, 0x59, 0x27, 0x80, 0xec, 0x5f,
  0x60, 0x51, 0x7f, 0xa9, 0x19, 0xb5, 0x4a, 0x0d, 0x2d, 0xe5, 0x7a, 0x9f, 0x93, 0xc9, 0x9c, 0xef,
  0xa0, 0xe0, 0x3b, 0x4d, 0xae, 0x2a, 0xf5, 0xb0, 0xc8, 0xeb, 0xbb, 0x3c, 0x83, 0x53, 0x99, 0x61,
  0x17, 0x2b, 0x04, 0x7e, 0xba, 0x77, 0xd6, 0x26, 0xe1, 0x69, 0x14, 0x63, 0x55, 0x21, 0x0c, 0x7d,
];

/**
 * 密钥扩展时使用
 * @type {number[]}
 */
let R_CON = [
  0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x1b, 0x36
];

/**
 * 列混淆时使用的矩阵
 */
let MIX_MATRIX = [
  '02', '03', '01', '01',
  '01', '02', '03', '01',
  '01', '01', '02', '03',
  '03', '01', '01', '02',
];

/**
 * 列混淆时使用的矩阵
 */
let INVERSE_MIX_MATRIX = [
  '0e', '0b', '0d', '09',
  '09', '0e', '0b', '0d',
  '0d', '09', '0e', '0b',
  '0b', '0d', '09', '0e',
];

/**
 * 字节替换
 * @param byte 2位16进制数，8bit
 * @param inverse 是否逆运算
 * @returns {string} 经过字节替换后的8bit
 */
let sub_bytes = (byte, inverse = false) => {
  if (byte.length !== 2) {
    console.log("出错信息")
    console.log(byte);
    throw new Error("字节替换的参数应该为2位16进制");
  }
  let hex = parseInt(byte[0], 16);
  let low = parseInt(byte[1], 16);
  // 记得补0
  if (!inverse) {
    return S_BOX[hex * 16 + low].toString(16).padStart(2, '0');
  } else {
    return INVERSE_S_BOX[hex * 16 + low].toString(16).padStart(2, '0');
  }
};

/**
 * 将十六进制的字符串每8位进行一次s盒替换
 * @param hexText 十六进制字符串
 * @param inverse 是否逆运算
 * @returns {string}
 */
let hex_sub_bytes = (hexText, inverse = false) => {
  let result = "";
  for (let i = 0; i < hexText.length; i += 2) {
    result += sub_bytes(hexText.substr(i, 2), inverse);
  }
  return result;
}

/**
 * 数组移动位置
 * @param array 指定一维数组
 * @param number 移动位数
 * @param isLeft 是否为左移
 */
let shift_array = (array, number, isLeft) => {
  let size = 4;
  let result = [4];
  for (let i = 0; i < 4; i++) {
    let shift_index;
    if (isLeft) {
      shift_index = (i + number + size) % size;
    } else {
      shift_index = (i - number + size) % size;
    }
    result[i] = array.substr(shift_index * 2, 2);
  }
  return result;
};

/**
 * 转置128bit文本
 * @param hexText 16进制文本
 * @returns {string}
 */
let transpose = (hexText) => {
  let result = "";
  result += hexText.substr(0, 2)
            + hexText.substr(8, 2)
            + hexText.substr(16, 2)
            + hexText.substr(24, 2);
  result += hexText.substr(2, 2)
    + hexText.substr(10, 2)
    + hexText.substr(18, 2)
    + hexText.substr(26, 2);
  result += hexText.substr(4, 2)
    + hexText.substr(12, 2)
    + hexText.substr(20, 2)
    + hexText.substr(28, 2);
  result += hexText.substr(6, 2)
    + hexText.substr(14, 2)
    + hexText.substr(22, 2)
    + hexText.substr(30, 2);
  return result;
}

/**
 * 将字符串数组转成字符串
 * @param array
 * @returns {string}
 */
let array_to_str = (array) => {
  let result = '';
  for (let i = 0; i < array.length; i++) {
    result += array[i];
  }
  return result;
}

/**
 * 行移位
 * @param state 指定状态数组
 * @param inverse 是否逆运算
 */
let shift_rows = (state, inverse = false) => {
  let result = [];
  state = transpose(state);
  if (!inverse) {
    result = result.concat(shift_array(state.slice(0, 8), 0, true))
    result = result.concat(shift_array(state.slice(8, 16), 1, true))
    result = result.concat(shift_array(state.slice(16, 24), 2, true));
    result = result.concat(shift_array(state.slice(24, 32), 3, true));
  } else {
    result = result.concat(shift_array(state.slice(0, 8), 0, false))
    result = result.concat(shift_array(state.slice(8, 16), 1, false))
    result = result.concat(shift_array(state.slice(16, 24), 2, false));
    result = result.concat(shift_array(state.slice(24, 32), 3, false));
  }
  result = transpose(array_to_str(result))
  return result;
};

/**
 * 02 异或乘法
 * @param hexText
 * @returns {string}
 */
let hex_multi_02 = (hexText) => {
  // 未移位前的最高位
  let highBit = to_4binary(hexText).charAt(0);
  // 左移一位
  let leftTemp = to_4binary(hexText).substr(1, 7).padEnd(8, '0');
  // 如果未移位的最高位为1，则与1b异或
  if (highBit === '1') {
    return xor_hex(binary_to_hex(leftTemp), '1b');
  }
  // 将二进制转成16进制输出
  return binary_to_hex(leftTemp);
}

/**
 * 04 异或乘法
 * @param hexText
 * @returns {string}
 */
let hex_multi_04 = (hexText) => {
  // 该乘法不一定满足结合律
  // 02 * hex + 02 * hex
  // xor_hex(hex_multi_02(hexText), hex_multi_02(hexText));
  // 02 * 02 * hex
  return hex_multi_02(hex_multi_02(hexText));
}

let hex_multi_08 = (hexText) => {
  return hex_multi_04(hex_multi_02(hexText));
}

/**
 * 16进制aes乘法
 * @param a 混淆矩阵的值
 * @param b 数据矩阵的数据
 * @returns {string}
 */
let hex_multi = (a, b) => {
  if (a === '02') {
    return hex_multi_02(b);
  } else if (a === '03') {
    // '03' * b = '01' * b xor '02' * b
    return xor_hex(b, hex_multi_02(b));
  } else if (a === '01') {
    // '01'返回自身
    return b;
  } else if (a === '0e' || a === '0E') {
    return xor_hex(xor_hex(hex_multi_08(b), hex_multi_04(b)), hex_multi_02(b));
  } else if (a === '0b' || a === '0B') {
    return xor_hex(b, xor_hex(hex_multi_08(b), hex_multi_02(b)));
  } else if (a === '0d' || a === '0D') {
    return xor_hex(b, xor_hex(hex_multi_08(b), hex_multi_04(b)));
  } else if (a === '09') {
    return xor_hex(b, hex_multi_08(b));
  }
}

/**
 * 混淆矩阵的一行与数据矩阵的一列相乘
 * @param matrixIndex 矩阵某一行
 * @param x1 数据矩阵一行的第一个
 * @param x2 数据矩阵一行的第二个
 * @param x3 数据矩阵一行的第三个
 * @param x4 数据矩阵一行的第四个
 * @param inverse 是否逆运算
 * @returns {string} 异或后的结果
 */
let hex_mix = (matrixIndex, x1, x2, x3, x4, inverse = false) => {
  let temp1 = !inverse ? hex_multi(MIX_MATRIX[matrixIndex * 4], x1) : hex_multi(INVERSE_MIX_MATRIX[matrixIndex * 4], x1);
  let temp2 = !inverse ? hex_multi(MIX_MATRIX[matrixIndex * 4 + 1], x2) : hex_multi(INVERSE_MIX_MATRIX[matrixIndex * 4 + 1], x2);
  let temp3 = !inverse ? hex_multi(MIX_MATRIX[matrixIndex * 4 + 2], x3) : hex_multi(INVERSE_MIX_MATRIX[matrixIndex * 4 + 2], x3);
  let temp4 = !inverse ? hex_multi(MIX_MATRIX[matrixIndex * 4 + 3], x4) : hex_multi(INVERSE_MIX_MATRIX[matrixIndex * 4 + 3], x4);
  return xor_hex(temp4, xor_hex(temp3, xor_hex(temp1, temp2)));
}

/**
 * 列混淆
 * @param hexText 指定状态数组
 * @param inverse 是否逆运算
 */
let mix_columns = (hexText, inverse = false) => {
  let result = [];
  for (let i = 0; i < 4; i++) {
    let temp = [];
    temp[0] = hex_mix(0, hexText.substr(i * 8, 2), hexText.substr(i * 8 + 2, 2), hexText.substr(i * 8 + 4, 2), hexText.substr(i * 8 + 6, 2), inverse);
    temp[1] = hex_mix(1, hexText.substr(i * 8, 2), hexText.substr(i * 8 + 2, 2), hexText.substr(i * 8 + 4, 2), hexText.substr(i * 8 + 6, 2), inverse);
    temp[2] = hex_mix(2, hexText.substr(i * 8, 2), hexText.substr(i * 8 + 2, 2), hexText.substr(i * 8 + 4, 2), hexText.substr(i * 8 + 6, 2), inverse);
    temp[3] = hex_mix(3, hexText.substr(i * 8, 2), hexText.substr(i * 8 + 2, 2), hexText.substr(i * 8 + 4, 2), hexText.substr(i * 8 + 6, 2), inverse);
    result = result.concat(temp);
  }
  return result;
}

/**
 * 密钥扩展时的T运算
 * @param input 32位文本
 * @param index R_CON的索引值
 * @returns {string}
 * @constructor
 */
let T = (input, index) => {
  // 输入左移一位
  let leftResult = left_move(input, 2);
  // 对每个字节进行s盒替换
  let subResult = sub_bytes(leftResult.substr(0, 2))
                + sub_bytes(leftResult.substr(2, 2))
                + sub_bytes(leftResult.substr(4, 2))
                + sub_bytes(leftResult.substr(6, 2));
  // 对每个字节与R_CON进行异或
  let xorResult = xor_hex(subResult.substr(0, 2).padStart(2, '0'), R_CON[index])
                + subResult.substr(2);
  return xorResult;
}

/**
 * 密钥扩展
 * @param hexKey
 * @returns {string|*}
 */
let key_extended = (hexKey) => {
  // 因为key值为16进制，所以128位密钥长度为32
  if (hexKey.length < 32) {
    return "长度不足128位"
  }
  let result = [];
  // 前4轮就是基本密钥
  for (let i = 0; i < 32; i += 8) {
	result.push(hexKey.substr(i, 8));
  }
  // 后四十轮通过计算
  for (let i = 4; i < 44; i++) {
    let temp = '';
    // 4 8 12... 等等通过T函数再次异或
    // 其余的为异或
    if (i % 4 === 0) {
      temp = xor_hex_fill(result[i - 4], T(result[i - 1], i / 4))
    } else {
      temp = xor_hex_fill(result[i - 4], result[i - 1]);
    }
    result.push(temp);
  }
  return result;
};

/**
 * aes 128位加密
 * @param hexText 16进制128位文本
 * @param hexKey 16进制128位密钥
 * @returns {string}
 */
let encrypt = (hexText, hexKey) => {
  if (hexText === null || hexKey === null) {
    return "长度不足64位"
  }
  if (hexText.length < 32 || hexKey.length < 32) {
    return '文本或密钥长度不足128位';
  }
  // 获取扩展密钥数组
  let extendedKeys = key_extended(hexKey);
  console.info("扩展密钥")
  console.info(extendedKeys)
  // 明文和第一组密钥 0,1,2,3 异或
  let tempText = xor_hex_fill(hexText.substr(0, 8), extendedKeys[0])
                    + xor_hex_fill(hexText.substr(8, 8), extendedKeys[1])
                    + xor_hex_fill(hexText.substr(16, 8), extendedKeys[2])
                    + xor_hex_fill(hexText.substr(24, 8), extendedKeys[3]);
  // 中间9轮加密
  for (let i = 0; i < 9; i++) {
    console.info("第" + (i + 1) + '轮：')
    let subTemp = hex_sub_bytes(tempText);
    console.info('s盒替换 :' + subTemp);
    let shiftTemp = shift_rows(subTemp);
    console.info('左移    :' + shiftTemp)
    let mixTemp = mix_columns(shiftTemp);
    mixTemp = array_to_str(mixTemp);
    console.info('混淆    :' + mixTemp)
    tempText = xor_hex_fill(mixTemp.substr(0, 8), extendedKeys[i * 4 + 4])
      + xor_hex_fill(mixTemp.substr(8, 8), extendedKeys[i * 4 + 5])
      + xor_hex_fill(mixTemp.substr(16, 8), extendedKeys[i * 4 + 6])
      + xor_hex_fill(mixTemp.substr(24, 8), extendedKeys[i * 4 + 7])
    console.info('轮密钥加:' + tempText)
  }
  // 第十轮
  console.info('第10轮：')
  // s盒替换
  tempText = hex_sub_bytes(tempText);
  console.info('s盒替换 :' + tempText);
  // 行移位
  tempText = shift_rows(tempText);
  console.info('左移    :' + tempText);
  let cipher = xor_hex_fill(tempText.substr(0, 8), extendedKeys[40])
    + xor_hex_fill(tempText.substr(8, 8), extendedKeys[41])
    + xor_hex_fill(tempText.substr(16, 8), extendedKeys[42])
    + xor_hex_fill(tempText.substr(24, 8), extendedKeys[43])
  console.info("密文输出: " + cipher);
  return cipher;
}

/**
 * aes 128位解密
 * @param hexText
 * @param hexKey
 * @returns {string}
 */
let decrypt = (hexCipher, hexKey) => {
  if (hexCipher === null || hexKey === null) {
    return "长度不足64位"
  }
  if (hexCipher.length < 32 || hexKey.length < 32) {
    return '文本或密钥长度不足128位';
  }
  // 获取扩展密钥数组
  let extendedKeys = key_extended(hexKey);
  // 轮密钥加 W[40-43]
  let tempText = xor_hex_fill(hexCipher.substr(0, 8), extendedKeys[40])
    + xor_hex_fill(hexCipher.substr(8, 8), extendedKeys[41])
    + xor_hex_fill(hexCipher.substr(16, 8), extendedKeys[42])
    + xor_hex_fill(hexCipher.substr(24, 8), extendedKeys[43]);
  console.info("w[40-43]:" + tempText);
  // 中间9轮加密
  for (let i = 0; i < 9; i++) {
    console.info("第" + (i + 1) + '轮：')
    // 逆行移位
    let shiftTemp = shift_rows(tempText, true);
    console.info('逆行运算  :' + shiftTemp)
    let subTemp = hex_sub_bytes(shiftTemp, true);
    console.info("逆s盒替换 :" + subTemp)
    tempText = xor_hex_fill(subTemp.substr(0, 8), extendedKeys[36 - i * 4])
      + xor_hex_fill(subTemp.substr(8, 8), extendedKeys[36 - i * 4 + 1])
      + xor_hex_fill(subTemp.substr(16, 8), extendedKeys[36 - i * 4 + 2])
      + xor_hex_fill(subTemp.substr(24, 8), extendedKeys[36 - i * 4 + 3])
    console.info("轮密钥加 :" + tempText)
    let mixTemp = mix_columns(tempText, true);
    tempText = array_to_str(mixTemp);
    console.info("逆列混淆 :" + tempText)
  }
  // 第十轮
  console.info('第十轮：')
  // 逆行移位
  tempText = shift_rows(tempText, true);
  // 逆s盒替换
  tempText = hex_sub_bytes(tempText, true);
  let cipher = xor_hex_fill(tempText.substr(0, 8), extendedKeys[0])
    + xor_hex_fill(tempText.substr(8, 8), extendedKeys[1])
    + xor_hex_fill(tempText.substr(16, 8), extendedKeys[2])
    + xor_hex_fill(tempText.substr(24, 8), extendedKeys[3])
  console.info("明文输出: " + cipher);
  return cipher;
}

  

    // Uploader
    function Uploader(path, file) {
        var hash, ready, progress, success, fail, done;
        function successed(arg1, arg2) {
            if (done) setTimeout(done, 0);
            if (success) success(arg1, arg2);
        }
        function failed(arg) {
            if (done) setTimeout(done, 0);
            if (fail) fail(arg);
        }
        var reqFail = function(ev) {
            failed("网络错误");
        }
        // param: hash
        // won't execute if fast-transmitted
        this.onready = function(callback) {
            ready = callback;
            return this;
        }
        // param: progress event
        this.onprogress = function(callback) {
            progress = callback;
            return this;
        }
        // param: is fast-transmission, space
        this.onsuccess = function(callback) {
            success = callback;
            return this;
        }
        // param: failure reason
        this.onfail = function(callback) {
            fail = callback;
            return this;
        }
        // param: none
        this.ondone = function(callback) {
            done = callback;
            return this;
        }
        // start uploading
        this.start = function() {
            FileEncrypter(file, blob => {
                new SHA1(blob, function(hash) {
                    this.hash = hash;
                    $.post("/cloud/fileExists", {hash: hash}, function(data) {
                        data = JSON.parse(data);
                        if (data.data) {
                            $.post("/cloud/hashupload", {hash: hash, path: path}, function(data) {
                                data = JSON.parse(data);
                                if (data.ret == 200) successed(true, data.data);
                                else failed(data.desc);
                            }).fail(reqFail);
                        } else {
                            if (ready) setTimeout(function() {
                                ready(hash);
                            }, 0);
                            var form = new FormData();
                            form.append("path", path);
                            form.append("file", blob);
                            $.ajax({
                                type: "POST",
                                url: "/cloud/upload",
                                enctype: "application/x-www-form-urlencoded",
                                contentType: false,
                                data: form,
                                processData: false,
                                xhr: function() {
                                    var xhr = $.ajaxSettings.xhr();
                                    xhr.upload.onprogress = function(ev) {
                                        if (progress) progress(ev);
                                    };
                                    return xhr;
                                },
                                success: function(data) {
                                    data = JSON.parse(data);
                                    if (data.ret == 200) {
                                        successed(false, data.data);
                                    } else {
                                        failed(data.desc)
                                    }
                                },
                                error: reqFail
                            });
                        }
                    }).fail(reqFail);
                });
            });
            return this;
        }
    }
</script>
<script>
    // Operations
    function getPath(ev) {
        for (var i = 0; i < ev.path.length; ++i) if (ev.path[i].path) return ev.path[i].path;
        return undefined;
    }
    function getName(path) {
        if (typeof path != "string") path = getPath(path);
        if (path.endsWith("/")) {
           return path.substring(path.lastIndexOf("/", path.length - 2) + 1, path.length - 1);
        }
        return path.substr(path.lastIndexOf("/") + 1);
    }
    const supportedExts = ['.bmp', '.jpg', '.pdf', '.png', '.txt'];
    const operations = {
        download: {
            icon: 'download',
            desc: '下载',
            action: function(ev) {
                // window.open('download?path=' + encodeURI(getPath(ev)));
                $.ajax({
                    type: 'GET',
                    url: 'download?path=' + encodeURI(getPath(ev)),
                    contentType: "application/octet-stream",
                    xhrFields: {responseType: 'blob'},
                    success: data => {
                        FileDecrypter(data, blob => {
                            var lnk = document.createElement('a');
                            lnk.href = URL.createObjectURL(blob);
                            lnk.setAttribute('download', getName(ev));
                            lnk.click();
                        });
                    },
                    error: networkErr,
                });
            }
        },
        preview: {
            icon: 'eye',
            desc: '预览',
            action: function(ev) {
                window.open('preview?path=' + encodeURI(getPath(ev)));
            }
        },
        rename: {
            icon: 'pencil',
            desc: '重命名',
            action: function(ev) {
                var name = getName(ev);
                var pos = name.endsWith('/') ? -1 : name.lastIndexOf('.');
                prompt("重命名为", function(newName) {
                    if (name == newName) return;
                    if (!newName) return;
                    if (newName.match(/[\\\/:*?"<>|\n]/)) {
                        alert("文件名含有非法字符！");
                        return;
                    }
                    if (newName == '.' || newName == '..') {
                        alert("文件名非法！");
                        return;
                    }
                    $.post("rename", {oldname: currentPath + name, newname: currentPath + newName}, function(data) {
                        data = JSON.parse(data);
                        if (data.ret == 200) {
                            loadFileList();
                        } else {
                            alert(data.desc);
                        }
                    }).fail(networkErr);
                }, name, pos == -1 ? true : [0, pos]);
            }
        },
        share: {
            icon: 'share-variant',
            desc: '分享',
            action: function(ev) {
                var path = getPath(ev);
                console.log(path);
            }
        },
        move: {
            icon: 'content-copy',
            desc: '移动',
            action: function(ev) {
                var path = getPath(ev);
                var pos = path.lastIndexOf('/', path.length - (path.endsWith('/') ? 2 : 0));
                selectDir(function(target) {
                    if (!target || target == path.substr(0, pos + 1)) return;
                    $.post("rename", {oldname: path, newname: target + path.substr(pos + 1)}, function(data) {
                        data = JSON.parse(data);
                        if (data.ret == 200) {
                            loadFileList();
                        } else {
                            alert(data.desc);
                        }
                    }).fail(networkErr);
                }, "移动至", path.substr(0, pos + 1), path.endsWith('/') ? path : undefined);
            }
        },
        delete: {
            icon: 'delete',
            desc: '删除',
            action: function(ev) {
                var path = getPath(ev), fn = getName(path);
                if (path.endsWith("/")) fn = "夹" + fn;
                confirm(`是否删除文件${fn}？`, "确认删除", function(result) {
                    if (result) {
                        $.post("delete", {path: path}, function(data) {
                            data = JSON.parse(data);
                            if (data.ret == 200) {
                                loadFileList();
                                setSpace(data.data);
                            } else {
                                alert(data.desc);
                            }
                        }).fail(networkErr);
                    }
                }, "btn-danger active");
            }
        },
        recover: {
            icon: 'undo',
            desc: '恢复文件',
            action: function(ev) {
                $.post("recover", {fid: getPath(ev)}, function(data) {
                    data = JSON.parse(data);
                    if (data.ret == 200) {
                        loadFileList();
                    } else {
                        alert(data.desc);
                    }
                }).fail(networkErr);
            }
        },
        deleteForever: {
            icon: 'delete-forever',
            desc: '彻底删除',
            action: function(ev) {
                confirm('是否彻底删除文件？', '确认删除', function(result) {
                    if (result) {
                        $.post("deleteForever", {fid: getPath(ev)}, function(data) {
                            data = JSON.parse(data);
                            if (data.ret == 200) {
                                loadFileList();
                            } else {
                                alert(data.desc);
                            }
                        }).fail(networkErr);
                    }
                }, "btn-danger active");
            }
        }
    };
    // Search
    document.getElementsByClassName("navbar")[0].getElementsByTagName("form")[0].onsubmit = function(e) {
        e.preventDefault();
    }
    onsearch = function(e) {
        location.hash = '?' + $("input[name=q]").blur().val();
    }
    // Location
    function availableHash(hash) {
        if (hash == "#trash") return true;
        if (hash == "#share") return true;
        if (hash.startsWith("#?")) return true;
        if (!hash.startsWith('#/')) return false;
        if (!hash.endsWith('/')) return false;
        if (hash.match(/[\\:*?"<>|]|\/\.\/|\/\.\.\//)) return false;
        return true;
    }
    var ignoreHashChange = false;
    onhashchange = function(ev) {
        if (ignoreHashChange) {
            ignoreHashChange = false;
            return;
        }
        if (!availableHash(location.hash)) {
            location = ev.oldURL;
            ignoreHashChange = true;
            return;
        }
        $(".modal").modal("hide");
        if (location.hash == "#trash") {
            buttonPress("trashBtn", true);
            buttonPress("shareBtn", false);
            $(".nf").attr("disabled", "");
            $("#files").addClass("d-none");
            document.title = "回收站 - EFRDS Cloud";
        } else if (location.hash == "#share") {
            buttonPress("shareBtn", true);
            buttonPress("trashBtn", false);
            $(".nf").attr("disabled", "");
            $("#files").addClass("d-none");
            document.title = "分享 - EFRDS Cloud";
        } else if (location.hash.startsWith("#?")) {
            document.title = "搜索 - EFRDS Cloud";
        } else {
            buttonPress("trashBtn", false);
            buttonPress("shareBtn", false);
            $(".nf").attr("disabled", false);
            $("#files").removeClass("d-none");
            document.title = location.hash.substr(1) + " - EFRDS Cloud";
        }
        setNavbar(location.hash.substr(1));
        loadFileList(location.hash.substr(1));
    }
    var currentPath = "/", tmpPath = "/";
    function setNavbar(path, $navbar, hrefFunc) {
        if (!$navbar) $navbar = $("#mainNav");
        if (!hrefFunc) hrefFunc = function(path) {
            return '#' + path;
        }
        var list, prefix = "";
        if (path == "trash") list = ["回收站"];
        else if (path == "share") list = ["分享"];
        else if (path[0] == "?") list = ["根目录", "搜索"];
        else {
            list = ("根目录" + path.substr(0, path.length - 1)).split('/');
            tmpPath = path;
            $("#trash").attr("aria-pressed", "false").removeClass("active");
        }
        $navbar.find(".breadcrumb-item").remove();
        var navbar = $navbar.find(".breadcrumb")[0];
        for (var i = 0; i < list.length; ++i) {
            var ele = document.createElement("li");
            ele.classList = "breadcrumb-item";
            if (i == list.length - 1) {
                ele.classList.add("active");
                ele.setAttribute("aria-current", "page");
                ele.innerText = list[i];
            } else {
                if (prefix) prefix += list[i] + "/";
                else prefix = "/";
                ele.innerHTML = `<a href="${hrefFunc(prefix)}">${list[i]}</a>`;
            }
            navbar.appendChild(ele);
        }
    }
    // File List
    var currentFileList = [];
    function clearFileList() {
        $("tbody").remove();
    }
    function setFileList(list) {
        if (!list) list = currentFileList;
        else currentFileList = list;
        clearFileList();
        list.sort(function(a, b) {
            if (a.is_dir ^ b.is_dir) return b.is_dir - a.is_dir;
            var key = window.key, order = window.order;
            if (key != "size" && key != "time") key = "name";
            if (key == "size") key = "filesize";
            if (key != "name" && a[key] == b[key]) {
                key = "name";
                order = "ascending";
            }
            if (order == "descending") {
                var t = a;
                a = b;
                b = t;
            }
            if (key == "filesize") {
                return a.filesize - b.filesize;
            }
            if (key == "time") {
                return new Date(a.time) - new Date(b.time);
            }
            a.name = a.filename.toLowerCase();
            b.name = b.filename.toLowerCase();
            return a.name < b.name ? -1 : a.name > b.name;
        });
        var body = $("table")[0].createTBody();
        for (var i = 0; i < list.length; ++i) {
            var f = list[i];
            var row = body.insertRow();
            row.classList = "row mx-0";
            row.dataset.toggle = "collapse";
            row.dataset.target = "#op" + i;
            row.setAttribute("aria-expanded", "true");
            row.setAttribute("aria-controls", "collapseOne");
            var cell = row.insertCell();
            cell.classList = "col-lg-9 col-md-7 col-sm-6 breakall cname";
            var ele = document.createElement("i");
            ele.classList = f.is_dir != 0 ? "MDI folder" : "MDI file";
            cell.appendChild(ele);
            if (f.is_dir != 0 && currentPath.startsWith('/')) {
                cell.appendChild(document.createTextNode(' '));
                ele = document.createElement("a");
                ele.classList = "noc";
                ele.href = `#${currentPath}${f.filename}/`;
                ele.innerText = f.filename;
                cell.appendChild(ele);
            } else {
                cell.appendChild(document.createTextNode(` ${f.filename}`));
            }
            if (f.path != undefined) {
                cell.appendChild(document.createElement("br"));
                ele = document.createElement("a");
                ele.classList = "sub";
                ele.href = '#' + f.path;
                ele.innerText = f.path;
                ele.onclick = function(ev) {
                    ev.stopPropagation();
                }
                cell.appendChild(ele);
            }
            cell = row.insertCell();
            cell.classList = "col-lg-1 col-sm-2 col-4 d-none d-sm-block small csize";
            cell.innerText = f.is_dir != 0 ? "-" : bytesToString(f.filesize);
            cell = row.insertCell();
            cell.classList = "col-lg-2 col-md-3 col-sm-4 col-4 d-none d-sm-block small ctime";
            cell.innerText = f.time;
            row = body.insertRow();
            row.classList = "row mx-0 collapse";
            row.id = "op" + i;
            row.dataset.parent = "table";
            var ops = [];
            if (currentPath == 'trash') ops = ['recover', 'deleteForever'];
            else if (currentPath == 'share') ops = []; // TODO
            else {
                if (f.is_dir == 0) ops = ['download', 'preview'];
                ops = ops.concat(['rename', 'share', 'move', 'delete']);
            }
            for (var op of ops) {
                cell = row.insertCell();
                cell.classList = `col-sm-${12/ops.length} col-6 p-1`;
                var btn = document.createElement("button");
                btn.classList = "btn m-0";
                btn.addEventListener("click", operations[op].action);
                btn.path = f.fid || (f.path || currentPath) + f.filename + (f.is_dir != 0 ? '/' : '');
                btn.innerHTML = `<i class="MDI ${operations[op].icon}"></i> ${operations[op].desc}`;
                if (op == 'preview') btn.disabled = true; // supportedExts.indexOf(f.filename.substr(f.filename.lastIndexOf('.'))) == -1;
                if (op == 'share') btn.disabled = true; // awsl
                cell.appendChild(btn);
            }
        }
        if (list.length == 0) {
            body.innerHTML = '<tr><td><h6 style="color: gray;" class="text-center m-0">文件夹为空</h6></td></tr>';
        }
        showColumn(key);
    }
    var loadingFileList = false;
    function loadFileList(path) {
        if (typeof path != "string") path = currentPath;
        else currentPath = path;
        if (loadFileList && path == currentFileList) return;
        loadingFileList = true;
        clearFileList();
        var query;
        if (path[0] == "/") query = $.post("show", {path: path});
        else if (path == "share") ; // TODO
        else if (path == "trash") query = $.post("recycle", {});
        else if (path[0] == '?') query = $.post("search", {keyword: path.substr(1)});
        if (query) query.done(function(data) {
            data = JSON.parse(data);
            if (data.ret == 200) {
                setFileList(data.data);
                loadingFileList = false;
            } else {
                alert(data.desc);
            }
        }).fail(networkErr);
    }
    var key = 'name', order = 'ascending';
    function sortBy(key) {
        $(".si").addClass("d-none");
        $("#si" + key).removeClass("d-none");
        window.key = key;
        showColumn(key);
        setFileList();
    }
    function sortOrder(order) {
        $("#orderIcon")[0].classList = "MDI sort-" + order;
        var oldcn = order == "ascending" ? "arrow-down-bold" : "arrow-up-bold";
        var newcn = order == "ascending" ? "arrow-up-bold" : "arrow-down-bold";
        $(".si").removeClass(oldcn).addClass(newcn);
        window.order = order;
        setFileList();
    }
    // UI
    window.onclick = function(ev) {
        if (!ev.isTrusted) return;
        if (!ev.path.includes($("tbody")[0])) {
            $("table .collapse.show").collapse('hide');
        }
    };
    function alert(desc, title) {
        $('#alert_desc').html(desc);
        $('#alert_title').html(title ? title : "提示");
        $(".modal[id!=alert]").modal("hide");
        $('#alert').modal();
    }
    function confirm(desc, title, callback, classList) {
        if (typeof title == "function") {
            classList = callback;
            callback = title;
            title = undefined;
        }
        if (typeof callback != "function") {
            classList = callback;
            callback = undefined;
        }
        if (!classList) classList = "btn-primary";
        $('#confirm_desc').html(desc);
        $('#confirm_title').html(title ? title : "确认");
        $(".modal[id!=confirm]").modal("hide");
        $("#confirm_confirm")[0].classList = "btn " + classList;
        $('#confirm').modal()[0].callback = callback;
    }
    function prompt(title, callback, defaultValue, selected) {
        if (typeof callback != "function") {
            selected = defaultValue;
            defaultValue = callback;
            callback = undefined;
        }
        if (!defaultValue) defaultValue = "";
        if (selected == undefined) selected = false;
        $("#prompt_title").html(title);
        var input = $("#prompt_input").val(defaultValue)[0];
        $(".modal[id!=prompt]").modal("hide");
        $("#prompt").modal()[0].callback = callback;
        if (selected) {
            if (typeof selected == "object") input.setSelectionRange(selected[0], selected[1]);
            else input.select();
        }
    }
    var selectingDir = '/', exceptDir;
    function selectDir(callback, title, defaultDir, exceptDir) {
        if (!title) title = "选择文件夹";
        if (!defaultDir) defaultDir = '/';
        if (!exceptDir) exceptDir = '_'
        $("#browse_title").html(title);
        $(".modal[id!=browse]").modal("hide");
        $("#browse").modal()[0].callback = callback;
        window.exceptDir = exceptDir;
        updateSelectingDir(defaultDir);
    }
    function updateSelectingDir(dir) {
        selectingDir = dir;
        $("#dirlist .list-group-item").remove();
        setNavbar(dir, $("#browseNav"), function(path) {
            return `javascript:updateSelectingDir('${path}');`;
        });
        $.post("showdir", {path: dir}, function(data) {
            data = JSON.parse(data);
            if (data.ret == 200) {
                var group = $("#dirlist")[0];
                for (var cdir of data.data) {
                    var ele = document.createElement("a");
                    ele.href = `javascript:updateSelectingDir("${dir + cdir.filename}/");`;
                    ele.classList = "list-group-item list-group-item-action";
                    if ((dir + cdir.filename + '/').startsWith(exceptDir)) {
                        ele.href = "javascript:void(0);";
                        ele.classList.add("disabled");
                    }
                    ele.innerText = cdir.filename;
                    group.appendChild(ele);
                }
                if (data.data.length == 0) $("#dirlist").html('<a href="javascript:void(0);" class="list-group-item list-group-item-action disabled">空</a>');
            } else {
                alert(data.desc);
            }
        }).fail(networkErr);
    }
    var availableSpace = 0;
    function setSpace(param) {
        $("#spaceDesc").text(bytesToString(param.used) + "/" + bytesToString(param.total));
        $("#spacePB").attr("aria-valuenow", param.used).attr("aria-valuemax", param.total).css("width", 100 * param.used / param.total + "%");
        availableSpace = parseInt(param.available);
    }
    // param: 'name' | 'size' | 'time'
    function showColumn(name) {
        if (name == 'name') {
            $(".cname").removeClass("col-8");
            $(".csize").addClass("d-none");
            $(".ctime").addClass("d-none");
        } else if (name == 'size') {
            $(".cname").addClass("col-8");
            $(".csize").removeClass("d-none");
            $(".ctime").addClass("d-none");
        } else if (name == 'time') {
            $(".cname").addClass("col-8");
            $(".csize").addClass("d-none");
            $(".ctime").removeClass("d-none");
        }
    }
    function buttonPress(id, state) {
        if (state === undefined) return $("#" + id).attr("aria-pressed") == "true";
        if (state != false) $("#" + id).attr("aria-pressed", "true").addClass("active");
        else $("#" + id).attr("aria-pressed", "false").removeClass("active");
    }
    function networkErr() {
        alert("加载失败");
    }
    function bytesToString(size) {
        if (size < 1000) return size + "B";
        var level = 0;
        while (size >= 1000) {
            size /= 1024;
            ++level;
        }
        return size.toFixed(1) + ['B', 'KB', 'MB', 'GB', 'TB'][level];
    }
    // Init
    var uploaders = [];
    var currentWorkers = 0;
    const maxWorkers = 5;
    document.body.onload = function() {
        $.post("cloudSpace", {}, function(data) {
            data = JSON.parse(data);
            setSpace(data.data);
        });
        $("#order").click(function (ev) {
            sortOrder($("#orderIcon").hasClass("sort-ascending") ? "descending" : "ascending");
        });
        $("#trashBtn").click(function (ev) {
            setTimeout(function() {
                if (buttonPress("trashBtn")) {
                    location = "#trash";
                } else {
                    location = "#" + tmpPath;
                }
            }, 0);
        });
        $("#shareBtn").click(function (ev) {
            setTimeout(function() {
                if (buttonPress("shareBtn")) {
                    location = "#share";
                } else {
                    location = "#" + tmpPath;
                }
            }, 0);
        });
        $("#refresh").click(loadFileList);
        $("#uploadBtn").click(function(ev) {
            $("#upload").modal();
        });
        $("#files").click(function(ev) {
            ev.stopPropagation();
        }).change(function(ev) {
            var files = $("#files")[0];
            var filelist = [];
            for (var f of files.files) {
                (function(f) {
                    var fele = document.createElement("div");
                    fele.classList = "my-4";
                    var ele = document.createElement("span");
                    ele.innerText = f.name;
                    fele.appendChild(ele);
                    fele.appendChild(document.createTextNode(" "));
                    var badge = document.createElement("span");
                    badge.classList = "badge badge-secondary";
                    badge.innerText = "等待中";
                    fele.appendChild(badge);
                    fele.appendChild(document.createElement("br"));
                    ele = document.createElement("a");
                    ele.classList = "sub";
                    ele.href = "#" + currentPath;
                    ele.innerText = currentPath;
                    fele.appendChild(ele);
                    fele.appendChild(document.createTextNode(" "));
                    ele = document.createElement("span");
                    ele.classList = "sub";
                    var current = document.createElement("span");
                    current.innerText = "0B";
                    ele.appendChild(current);
                    ele.appendChild(document.createTextNode("/" + bytesToString(f.size)));
                    fele.appendChild(ele);
                    ele = document.createElement("div");
                    ele.classList = "progress";
                    var progress = document.createElement("div");
                    progress.classList = "progress-bar";
                    progress.setAttribute("role", "progressbar");
                    progress.setAttribute("aria-valuenow", "0");
                    progress.setAttribute("aria-valuemin", "0");
                    progress.setAttribute("aria-valuemax", f.size);
                    ele.appendChild(progress);
                    fele.appendChild(ele);
                    $("#upload .modal-body").append(fele);
                    var $uplds = $("#uploadings");
                    var left = $uplds.text();
                    if (left) left = parseInt(left) + 1;
                    else left = 1;
                    $uplds.text(left);
                    var uploadPath = currentPath;
                    var worker = new Uploader(currentPath + f.name, f).onready(function(hash) {
                        badge.classList = "badge badge-info";
                        badge.innerText = "上传中";
                    }).onprogress(function(ev) {
                        current.innerText = bytesToString(ev.loaded);
                        progress.style.width = ev.loaded * 100 / ev.total + "%";
                        progress.setAttribute("aria-valuenow", ev.loaded);
                    }).onsuccess(function(fast, space) {
                        badge.classList = "badge badge-success";
                        badge.innerText = (fast ? "秒" : "上") + "传成功";
                        current.innerText = bytesToString(f.size);
                        progress.style.width = "100%";
                        progress.setAttribute("aria-valuenow", f.size);
                        setSpace(space);
                    }).onfail(function(reason) {
                        badge.classList = "badge badge-danger";
                        badge.innerText = reason;
                    }).ondone(function() {
                        var left = parseInt($uplds.text()) - 1;
                        $uplds.text(left ? left : "");
                        if (currentPath == uploadPath) loadFileList();
                        if (uploaders.length) {
                            uploaders.shift().start();
                        } else {
                            currentWorkers--;
                        }
                    });
                    var t = worker.start;
                    worker.start = function() {
                        badge.innerText = "准备中";
                        t();
                    }
                    if (currentWorkers < maxWorkers) {
                        currentWorkers++;
                        worker.start();
                    } else {
                        uploaders.push(worker);
                    }
                })(f);
            }
            files.value = "";
            $("#upload div.h-100").append($("#files"))
            $("#upload").modal();
        });
        $("#newFolder").click(function(ev) {
            prompt("新建文件夹", function(name) {
                if (name) {
                    $.post("newFolder", {path: currentPath + name + "/"}, function(data) {
                        data = JSON.parse(data);
                        if (data.ret == 200) {
                            loadFileList();
                        } else {
                            alert(data.desc);
                        }
                    }).fail(networkErr);
                }
            });
        });
        $("thead th").click(function (ev) {
            var path = ev.originalEvent.path;
            var key = "";
            var keys = ["name", "size", "time"];
            for (var i = 0; i < keys.length; ++i) {
                if (path.includes($("thead .c" + keys[i])[0])) {
                    key = keys[i];
                    break;
                }
            }
            if (!key) return;
            if (key == window.key) {
                sortOrder(order == "ascending" ? "descending" : "ascending");
            } else {
                sortBy(key);
            }
        });
        $("#confirm_confirm").click(function(ev) {
            var prompt = $("#confirm")[0];
            if (prompt.callback) {
                prompt.callback(true);
                prompt.callback = undefined;
                $("#confirm").modal("hide");
            }
        });
        $("#confirm").on("hide.bs.modal", function(ev) {
            var prompt = $("#confirm")[0];
            if (prompt.callback) {
                prompt.callback(false);
                prompt.callback = undefined;
            }
        });
        $("#prompt_confirm").click(function(ev) {
            var prompt = $("#prompt")[0];
            if (prompt.callback) {
                prompt.callback($("#prompt_input").val());
                prompt.callback = undefined;
                $("#prompt").modal("hide");
            }
        });
        $("#prompt_input").keydown(function(ev) {
            if (ev.keyCode == 13) {
                $("#prompt_confirm").click();
            }
        });
        $("#prompt").on("shown.bs.modal", function(ev) {
            $("#prompt_input").focus();
        }).on("hide.bs.modal", function(ev) {
            var prompt = $("#prompt")[0];
            if (prompt.callback) {
                prompt.callback(undefined);
                prompt.callback = undefined;
            }
        });
        $("#browse_confirm").click(function(ev) {
            var browse = $("#browse")[0];
            if (browse.callback) {
                browse.callback(selectingDir);
                browse.callback = undefined;
                $("#browse").modal("hide");
            }
        });
        $("#browse").on("hide.bs.modal", function(ev) {
            var browse = $("#browse")[0];
            if (browse.callback) {
                browse.callback(undefined);
                browse.callback = undefined;
            }
        })
        $(".modal").click(function (ev) {
            ev.stopPropagation();
        });
        if (!availableHash(location.hash)) {
            location.hash = "#/";
        } else {
            onhashchange();
        }
        $.post("getKey", {}, function(data) {
            data = JSON.parse(data);
            if (data.ret == 200) {
                encryptKey = data.data;
            } else {
                alert(data.desc);
            }
        }).fail(() => alert('加载用户密钥失败，请刷新页面重试'));
    };
</script>
